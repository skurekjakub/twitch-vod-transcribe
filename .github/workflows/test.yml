name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: [satriel-vod-transcribe]
    
    steps:
      - name: Clean workspace
        run: git clean -ffdx || true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install bats-core and helpers
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git test/bats-core
          git clone --depth 1 https://github.com/bats-core/bats-support.git test/bats-support
          git clone --depth 1 https://github.com/bats-core/bats-assert.git test/bats-assert
          git clone --depth 1 https://github.com/bats-core/bats-file.git test/bats-file

      - name: Make scripts executable
        run: |
          chmod +x vod
          chmod +x scripts/*.sh
          chmod +x lib/*.sh
          chmod +x test/run_tests.sh

      - name: Run tests
        run: |
          cd test
          ./bats-core/bin/bats --verbose-run *.bats

  lint:
    runs-on: [satriel-vod-transcribe]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run shellcheck on main scripts
        run: |
          shellcheck vod
          shellcheck scripts/*.sh
          shellcheck lib/*.sh
        continue-on-error: true  # Don't fail the build on lint warnings
