#!/bin/bash

# VOD - Unified CLI for Twitch VOD & YouTube Video Processing
# 
# A modular bash/Python pipeline for downloading and transcribing
# Twitch VODs and YouTube videos using OpenAI's Whisper model.
#
# Usage: vod <command> [options]
#
# Commands:
#   download          Download video with chapter splitting
#   transcribe        Download Twitch VOD and transcribe to text
#   youtube           Fetch YouTube captions or transcribe
#   list              List Twitch channel VODs
#   batch download    Batch download from URL file
#   batch transcribe  Batch transcribe from URL file
#   split             Split video into time-based chunks
#   twitchdownloader  Download with chat overlay (TwitchDownloader)
#
# Run 'vod <command> --help' for command-specific help.

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="${SCRIPT_DIR}/scripts"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored output
print_error() { echo -e "${RED}Error: $1${NC}" >&2; }
print_success() { echo -e "${GREEN}$1${NC}"; }
print_warning() { echo -e "${YELLOW}$1${NC}"; }
print_info() { echo -e "${BLUE}$1${NC}"; }

# Show main help
show_help() {
  cat << 'EOF'
VOD - Unified CLI for Twitch VOD & YouTube Video Processing

Usage: vod <command> [options]

Commands:
  download <url>              Download video with chapter splitting
                              Supports YouTube, Twitch, and other yt-dlp sites
                              Outputs to /nas/vods/<channel>/ or videos/

  transcribe <url>            Download Twitch VOD and transcribe to text
                              Uses twitch-dl + faster-whisper

  youtube <url>               Fetch YouTube captions or transcribe
                              Tries captions first, falls back to Whisper

  list <channel>              List Twitch channel VODs
                              Options: --urls-only, --limit N, --chapters

  batch download [file]       Batch download from URL file
                              Default file: urls-vods

  batch transcribe [file]     Batch transcribe from URL file
                              Default file: urls.txt

  split <file> [hours]        Split video into time-based chunks
                              Default: 5-hour chunks

  twitchdownloader <url>      Download Twitch VOD with chat overlay
                              Uses TwitchDownloaderCLI

Options:
  -h, --help                  Show this help message
  -v, --version               Show version information

Examples:
  vod download https://www.youtube.com/watch?v=dQw4w9WgXcQ
  vod transcribe https://www.twitch.tv/videos/2588036186
  vod youtube https://www.youtube.com/watch?v=dQw4w9WgXcQ --download
  vod list forsen --urls-only --limit 10
  vod batch download urls-vods
  vod batch transcribe --continue-on-error
  vod split video.mp4 4

Run 'vod <command> --help' for command-specific help.
EOF
}

# Show version
show_version() {
  echo "vod 1.0.0"
  echo "Twitch VOD & YouTube Video Transcriber"
}

# Validate scripts directory exists
check_scripts_dir() {
  if [[ ! -d "$SCRIPTS_DIR" ]]; then
    print_error "Scripts directory not found: $SCRIPTS_DIR"
    exit 1
  fi
}

# Run a script from the scripts directory
run_script() {
  local script_name="$1"
  shift
  local script_path="${SCRIPTS_DIR}/${script_name}"
  
  if [[ ! -f "$script_path" ]]; then
    print_error "Script not found: $script_path"
    exit 1
  fi
  
  if [[ ! -x "$script_path" ]]; then
    print_error "Script not executable: $script_path"
    print_info "Run: chmod +x $script_path"
    exit 1
  fi
  
  exec "$script_path" "$@"
}

# Main command routing
main() {
  # No arguments - show help
  if [[ $# -eq 0 ]]; then
    show_help
    exit 0
  fi
  
  # Parse main command
  local command="$1"
  shift
  
  case "$command" in
    -h|--help|help)
      show_help
      exit 0
      ;;
    -v|--version|version)
      show_version
      exit 0
      ;;
    download)
      check_scripts_dir
      run_script "download.sh" "$@"
      ;;
    transcribe)
      check_scripts_dir
      run_script "transcribe.sh" "$@"
      ;;
    youtube|yt)
      check_scripts_dir
      run_script "youtube.sh" "$@"
      ;;
    list)
      check_scripts_dir
      run_script "list.sh" "$@"
      ;;
    batch)
      # Handle batch subcommands
      if [[ $# -eq 0 ]]; then
        print_error "Missing batch subcommand"
        echo "Usage: vod batch <download|transcribe> [options]"
        exit 1
      fi
      
      local batch_cmd="$1"
      shift
      
      case "$batch_cmd" in
        download)
          check_scripts_dir
          run_script "batch-download.sh" "$@"
          ;;
        transcribe)
          check_scripts_dir
          run_script "batch-transcribe.sh" "$@"
          ;;
        *)
          print_error "Unknown batch command: $batch_cmd"
          echo "Usage: vod batch <download|transcribe> [options]"
          exit 1
          ;;
      esac
      ;;
    split)
      check_scripts_dir
      run_script "split.sh" "$@"
      ;;
    twitchdownloader|td)
      check_scripts_dir
      run_script "twitchdownloader.sh" "$@"
      ;;
    *)
      print_error "Unknown command: $command"
      echo ""
      echo "Run 'vod --help' for a list of available commands."
      exit 1
      ;;
  esac
}

main "$@"
